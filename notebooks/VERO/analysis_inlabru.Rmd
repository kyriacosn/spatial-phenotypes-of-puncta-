---
title: "Spatial Analysis with inlabru"
output: html_notebook
---

## Load libraries

```{r message=FALSE}
library(sf)
library(INLA)
library(inlabru)
library(fmesher)
library(raster)
library(mgcv)
library(ggplot2)
library(terra)
bru_safe_sp(force = TRUE)
```

## Read the data

We first start by reading the for the point patterns, the boundaries and external boxes of all the cells in the data base as *sf* objects and then we read the covariate images as *terra raster* objects.

```{r}
all.peroxisomes <- st_read("../../data/processed/VERO/peroxisomes.geojson",crs = NA)
all.boundaries <- st_read("../../data/processed/VERO/domain.geojson",crs = NA)
all.meshboxes <- st_read("../../data/processed/VERO//meshbox.geojson",crs = NA)


rast.mt <- rast("../../data/processed/VERO/mitochondria.tif")
rast.er <- rast("../../data/processed/VERO/er.tif")
rast.nd <- rast("../../data/processed/VERO/nucleus_distance.tif")
rast.fd <- rast("../../data/processed/VERO/fractional_distance.tif")

```

Let's inspect our data set,

```{r}
ggplot() +
  gg(all.meshboxes, alpha = 0) +
  gg(all.boundaries, fill ="red",alpha = 0.1) +
  gg(all.peroxisomes,color = "darkgreen") 
```

## Choose cells for the analysis

The data set consists of 6 cells, from those 6 we can make a choice on which will be used for the inference by filtering them out through the data set, here we will use all the cells in the data-set

```{r}
cell_indx <- c(1,2,3,4,5,6)

boundary <- all.boundaries[cell_indx, ]

meshboxes <- all.meshboxes[cell_indx, ]

inside.indx <- apply(st_intersects(all.peroxisomes, boundary, sparse = FALSE),1, function(x) any(x))
peroxisomes <- all.peroxisomes[inside.indx, ]  
```

This filtering is not necessary for the covariate objects as the for the analysis they are sampled based on location therefore the regions needed will be sampled correctly as long as the objects stay aligned.

A nessesary step in spatial analysis with INLA is the construction of a mesh for the domain, and an external mesh which is necessary to avoid artificial boundary effects on the random field.

In the construction of the mesh, we choose the maximum length for the edges of the mesh triangles to be 1um as this is the resolution for the size of our covariate components. The maximum edge length for the outer mesh is set at 4um. Last we set a cutoff/minimum length for the edge length to be 0.2 as very small triangles can lead to numerical problems down the line of the analysis.

```{r}
mesh <- fm_mesh_2d_inla(boundary = list(boundary,meshboxes), max.edge = c(1, 4),cutoff = 0.2)
```

We can plot everything to check that the mesh and the points (and other objects) are as expected

```{r}
ggplot() +
  gg(mesh, fill ="red",alpha = 0.1) +
  gg(peroxisomes,color = "darkgreen") 
```

## Quantifying spatial phenotype of peroxisomes

To quantify the spatial phenotype of peroxisomes, we choose the following model for the mean density $\lambda$,

$$
 \ln \lambda = \beta_0 P_0(\mathbf{r}) + b_{MT} P_{MT}(\mathbf{r}) + b_{ER} P_{ER}(\mathbf{r}) + b_{FD} P_{FD}(\mathbf{r}) + GF(r;\mu =0,\Sigma)
$$

where $P_{\cdot}$ are the covariate maps where, $MT$ : mitochondria $ER$ : the ER, $FD$ fractional distance, and last the structured random effect as a gaussian random field with mean zero and a correlation structure. For the Gaussian random field we need to make a choice on its correlation structure, we choose the Matern correlation structure with smoothness parameter $\alpha =2$.

For the above fixed effects we choose a rather non-informative prior, which is the default of inlabru which is a normal distribution with mean zero and presision 0.001. For the GF we choose the PC-prior which was derived to penalize the complexity of the field (cite). We specify the tails of the marginal distributions of the standard deviation $P(\sigma > 2) = 0.01$ and $P(\rho < 1) = 0.01$ . Essentially, we specify that the correlation length should be larger than $1 \mu m$ and the standard deviation less than $2$. These are reasonable and weekly-informative priors as we have no prior information on this model.

```{r}
matern <- inla.spde2.pcmatern(mesh, prior.sigma = c(2, 0.01), prior.range = c(1, 0.01))
```

Now we can construct the model, by including our components in a formula

```{r}
model<- geometry ~ 
  random.field(geometry, model = matern) +
  mitochondria(rast.mt, model = "linear") +    
  er(rast.er, model = "linear") +
  fractional.distance(rast.fd, model = "linear") +
  Intercept(1)
```

and fit the model (with these settings it takes around 30 min to run when you include all the cells)

```{r}
fit <- lgcp(model, peroxisomes ,samplers = boundary , domain = list(geometry = mesh))

```

```{r paged.print=FALSE}
summary(fit)
```

Lets plot the marginal posterior distributions to get an idea of the sign and magnitude of the parameters

```{r}
multiplot(plot(fit, "Intercept"),
          plot(fit, "mitochondria"),
          plot(fit, "er"),
          plot(fit,"fractional.distance"),
          plot(spde.posterior(fit, "random.field", what = "range")),
          plot(spde.posterior(fit, "random.field", what = "variance"))
          ,cols = 2
          )
```

```{r}

```

We see a positive association with the fractional distance with

-   Fractional distance: the mode of the coeficient is around 3, which can be roughly interpreted as in the absence of the other effects the mean density near the nucleus is $e^{3}$ higher than at the border

-    Mitochondria: There is a negative spatial overlap of peroxisomes and mitochondria, which can be interpreted as spatial exclusion, however this does not imply absense of proximity or even direct contact

-   ER: the mean density has a positive association with the presense of ER, suggesting spatial association

-   GRF: The GRF captures hidden variability not explained by the covariates. This variability has a length scale around $20\mu m$ and it varies standard deviation of around $1$ meaning that hotspots ($GRF = \sigma$) have $e^{2}\approx 10$ times higher mean density than cold spots ($GRF = -\sigma$)

We can plot the predicted contribution of different components, lets inspect the effect of the GRF:

```{r}
pred.cell <- all.boundaries[3, ]
pred.grid <- fm_pixels(mesh, mask = pred.cell)


```

```{r}

formulas <- ~ list(
rf = random.field ,
lambda = exp(Intercept +mitochondria + er + fractional.distance + random.field))
pred.rf <- predict(fit, pred.grid,  formulas,   n.samples = 5) 
```

```{r}
p <-ggplot() +
  gg(pred.rf$lambda, geom = "tile") +
  geom_segment(aes(x = 160, y = 90, xend = 170, yend = 90), color = "black", size = 1) +
    scale_fill_gradient(low = "darkgreen", high = "lightgreen"  ) +
  geom_segment(aes(x = 160, y = 90, xend = 170, yend = 90), color = "black", size = 1) +
  gg(peroxisomes3,color = "green",size = 0.3) +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),  # Removes all axis text (numbers)
    axis.title.x = element_blank(),  # Removes x-axis label/title
    axis.title.y = element_blank(),   # Removes y-axis label/title
    legend.position = "bottom",  # Move legend to bottom
    legend.key.width = unit(1.5, "cm") # Removes y-axis label/title
  )+
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))


ggsave("../../figures/VERO/cell3_mean_density.pdf", plot = p, width = 7, height = 3, units = "in")

```

```{r}
cell_indx_3 <- c(3)

boundary3 <- all.boundaries[cell_indx_3, ]

inside.indx <- apply(st_intersects(all.peroxisomes, boundary3, sparse = FALSE),1, function(x) any(x))
peroxisomes3 <- all.peroxisomes[inside.indx, ]  
```

```{r}
p <-ggplot() +
  gg(pred.rf$rf, geom = "tile") +
  scale_fill_gradient(
    limits = c(-2.5, 2.5)  ) +
  geom_segment(aes(x = 160, y = 90, xend = 170, yend = 90), color = "black", size = 1) +
  gg(peroxisomes3,color = "green",size = 0.3) +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),  # Removes all axis text (numbers)
    axis.title.x = element_blank(),  # Removes x-axis label/title
    axis.title.y = element_blank(),
    legend.position = "bottom",  # Move legend to bottom
    legend.key.width = unit(1.5, "cm") # Removes y-axis label/title
  )+
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))

ggsave("../../figures/VERO/cell3_rf.pdf", plot = p, width = 7, height = 3, units = "in")

```

In agreement with the marginals we see variation "blobs" in the order of 20 um

Last we can make a map of the predicted mean density

```{r}
pred.meandensity <- predict(fit, pred.grid,
    ~ exp(Intercept +mitochondria + er + fractional.distance + random.field),
    n.samples = 1)
```

## Predicting the mean density from the covariates

Here we will explore the possibility to use our model to predict the mean density of peroxisomes without seeing any of its actual peroxisome locations. To do this we will fit our model on 5 of the cells and predict on the 6th that was left out. The prediction will use the covariate field corresponding to the prediction cell, however in regards to the random spatial effect we cannot "project" anything, so the predicted outcome will come with a missing spatial variation

```{r}
fit_cells <- c(1,2,3)

# Filter the domain boundaries, mesh boxes and points inside the domains of fit_cells

boundary <- all.boundaries[fit_cells, ]

meshboxes <- all.meshboxes[fit_cells, ]

inside.indx <- apply(st_intersects(all.peroxisomes, boundary, sparse = FALSE),1, function(x) any(x))
peroxisomes <- all.peroxisomes[inside.indx, ]  
```
